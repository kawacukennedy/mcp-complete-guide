apiVersion: v1
kind: Namespace
metadata:
  name: gatekeeper-system
---
# Install OPA Gatekeeper (simplified - use official Helm chart in production)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gatekeeper-controller-manager
  namespace: gatekeeper-system
spec:
  replicas: 1
  selector:
    matchLabels:
      control-plane: controller-manager
      gatekeeper.sh/system: "yes"
  template:
    metadata:
      labels:
        control-plane: controller-manager
        gatekeeper.sh/system: "yes"
    spec:
      containers:
      - name: manager
        image: openpolicyagent/gatekeeper:latest
        command:
          - /manager
        args:
          - --port=8443
          - --logtostderr
        ports:
        - containerPort: 8443
---
# Constraint Template for MCP policies
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: mcpaccess
spec:
  crd:
    spec:
      names:
        kind: MCPAccess
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package mcp.authz
        violation[{"msg": msg}] {
          input.review.object.metadata.name == "mcp-server"
          not input.review.object.spec.containers[0].image == "trusted-registry/mcp:*"
          msg := "MCP server must use trusted image"
        }